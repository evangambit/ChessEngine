#ifndef MOVEGEN_SLIDING_H
#define MOVEGEN_SLIDING_H

#include "../Position.h"
#include "../utils.h"

#include <bit>

namespace ChessEngine {

namespace {

// Code for generating:
// for (int i = 0; i < 8; ++i) {
//   const uint8_t piece = 1 << i;
//   for (int j = 0; j < 256; ++j) {
//     const uint8_t obstacles = j;
//     uint8_t r = 0;
//     for (int k = i + 1; k < 8; ++k) {
//       r |= 1 << k;
//       if (obstacles & (1 << k)) {
//         break;
//       }
//     }
//     for (int k = i - 1; k >= 0; --k) {
//       r |= 1 << k;
//       if (obstacles & (1 << k)) {
//         break;
//       }
//     }
//     std::cout << unsigned(r) << ",";
//     if (j % 8 == 7) {
//       std::cout << std::endl;
//     } else {
//       std::cout << " ";
//     }
//   }
// }


uint8_t kSlideLookup[2048] = {
254, 254, 2, 2, 6, 6, 2, 2,
14, 14, 2, 2, 6, 6, 2, 2,
30, 30, 2, 2, 6, 6, 2, 2,
14, 14, 2, 2, 6, 6, 2, 2,
62, 62, 2, 2, 6, 6, 2, 2,
14, 14, 2, 2, 6, 6, 2, 2,
30, 30, 2, 2, 6, 6, 2, 2,
14, 14, 2, 2, 6, 6, 2, 2,
126, 126, 2, 2, 6, 6, 2, 2,
14, 14, 2, 2, 6, 6, 2, 2,
30, 30, 2, 2, 6, 6, 2, 2,
14, 14, 2, 2, 6, 6, 2, 2,
62, 62, 2, 2, 6, 6, 2, 2,
14, 14, 2, 2, 6, 6, 2, 2,
30, 30, 2, 2, 6, 6, 2, 2,
14, 14, 2, 2, 6, 6, 2, 2,
254, 254, 2, 2, 6, 6, 2, 2,
14, 14, 2, 2, 6, 6, 2, 2,
30, 30, 2, 2, 6, 6, 2, 2,
14, 14, 2, 2, 6, 6, 2, 2,
62, 62, 2, 2, 6, 6, 2, 2,
14, 14, 2, 2, 6, 6, 2, 2,
30, 30, 2, 2, 6, 6, 2, 2,
14, 14, 2, 2, 6, 6, 2, 2,
126, 126, 2, 2, 6, 6, 2, 2,
14, 14, 2, 2, 6, 6, 2, 2,
30, 30, 2, 2, 6, 6, 2, 2,
14, 14, 2, 2, 6, 6, 2, 2,
62, 62, 2, 2, 6, 6, 2, 2,
14, 14, 2, 2, 6, 6, 2, 2,
30, 30, 2, 2, 6, 6, 2, 2,
14, 14, 2, 2, 6, 6, 2, 2,
253, 253, 253, 253, 5, 5, 5, 5,
13, 13, 13, 13, 5, 5, 5, 5,
29, 29, 29, 29, 5, 5, 5, 5,
13, 13, 13, 13, 5, 5, 5, 5,
61, 61, 61, 61, 5, 5, 5, 5,
13, 13, 13, 13, 5, 5, 5, 5,
29, 29, 29, 29, 5, 5, 5, 5,
13, 13, 13, 13, 5, 5, 5, 5,
125, 125, 125, 125, 5, 5, 5, 5,
13, 13, 13, 13, 5, 5, 5, 5,
29, 29, 29, 29, 5, 5, 5, 5,
13, 13, 13, 13, 5, 5, 5, 5,
61, 61, 61, 61, 5, 5, 5, 5,
13, 13, 13, 13, 5, 5, 5, 5,
29, 29, 29, 29, 5, 5, 5, 5,
13, 13, 13, 13, 5, 5, 5, 5,
253, 253, 253, 253, 5, 5, 5, 5,
13, 13, 13, 13, 5, 5, 5, 5,
29, 29, 29, 29, 5, 5, 5, 5,
13, 13, 13, 13, 5, 5, 5, 5,
61, 61, 61, 61, 5, 5, 5, 5,
13, 13, 13, 13, 5, 5, 5, 5,
29, 29, 29, 29, 5, 5, 5, 5,
13, 13, 13, 13, 5, 5, 5, 5,
125, 125, 125, 125, 5, 5, 5, 5,
13, 13, 13, 13, 5, 5, 5, 5,
29, 29, 29, 29, 5, 5, 5, 5,
13, 13, 13, 13, 5, 5, 5, 5,
61, 61, 61, 61, 5, 5, 5, 5,
13, 13, 13, 13, 5, 5, 5, 5,
29, 29, 29, 29, 5, 5, 5, 5,
13, 13, 13, 13, 5, 5, 5, 5,
251, 251, 250, 250, 251, 251, 250, 250,
11, 11, 10, 10, 11, 11, 10, 10,
27, 27, 26, 26, 27, 27, 26, 26,
11, 11, 10, 10, 11, 11, 10, 10,
59, 59, 58, 58, 59, 59, 58, 58,
11, 11, 10, 10, 11, 11, 10, 10,
27, 27, 26, 26, 27, 27, 26, 26,
11, 11, 10, 10, 11, 11, 10, 10,
123, 123, 122, 122, 123, 123, 122, 122,
11, 11, 10, 10, 11, 11, 10, 10,
27, 27, 26, 26, 27, 27, 26, 26,
11, 11, 10, 10, 11, 11, 10, 10,
59, 59, 58, 58, 59, 59, 58, 58,
11, 11, 10, 10, 11, 11, 10, 10,
27, 27, 26, 26, 27, 27, 26, 26,
11, 11, 10, 10, 11, 11, 10, 10,
251, 251, 250, 250, 251, 251, 250, 250,
11, 11, 10, 10, 11, 11, 10, 10,
27, 27, 26, 26, 27, 27, 26, 26,
11, 11, 10, 10, 11, 11, 10, 10,
59, 59, 58, 58, 59, 59, 58, 58,
11, 11, 10, 10, 11, 11, 10, 10,
27, 27, 26, 26, 27, 27, 26, 26,
11, 11, 10, 10, 11, 11, 10, 10,
123, 123, 122, 122, 123, 123, 122, 122,
11, 11, 10, 10, 11, 11, 10, 10,
27, 27, 26, 26, 27, 27, 26, 26,
11, 11, 10, 10, 11, 11, 10, 10,
59, 59, 58, 58, 59, 59, 58, 58,
11, 11, 10, 10, 11, 11, 10, 10,
27, 27, 26, 26, 27, 27, 26, 26,
11, 11, 10, 10, 11, 11, 10, 10,
247, 247, 246, 246, 244, 244, 244, 244,
247, 247, 246, 246, 244, 244, 244, 244,
23, 23, 22, 22, 20, 20, 20, 20,
23, 23, 22, 22, 20, 20, 20, 20,
55, 55, 54, 54, 52, 52, 52, 52,
55, 55, 54, 54, 52, 52, 52, 52,
23, 23, 22, 22, 20, 20, 20, 20,
23, 23, 22, 22, 20, 20, 20, 20,
119, 119, 118, 118, 116, 116, 116, 116,
119, 119, 118, 118, 116, 116, 116, 116,
23, 23, 22, 22, 20, 20, 20, 20,
23, 23, 22, 22, 20, 20, 20, 20,
55, 55, 54, 54, 52, 52, 52, 52,
55, 55, 54, 54, 52, 52, 52, 52,
23, 23, 22, 22, 20, 20, 20, 20,
23, 23, 22, 22, 20, 20, 20, 20,
247, 247, 246, 246, 244, 244, 244, 244,
247, 247, 246, 246, 244, 244, 244, 244,
23, 23, 22, 22, 20, 20, 20, 20,
23, 23, 22, 22, 20, 20, 20, 20,
55, 55, 54, 54, 52, 52, 52, 52,
55, 55, 54, 54, 52, 52, 52, 52,
23, 23, 22, 22, 20, 20, 20, 20,
23, 23, 22, 22, 20, 20, 20, 20,
119, 119, 118, 118, 116, 116, 116, 116,
119, 119, 118, 118, 116, 116, 116, 116,
23, 23, 22, 22, 20, 20, 20, 20,
23, 23, 22, 22, 20, 20, 20, 20,
55, 55, 54, 54, 52, 52, 52, 52,
55, 55, 54, 54, 52, 52, 52, 52,
23, 23, 22, 22, 20, 20, 20, 20,
23, 23, 22, 22, 20, 20, 20, 20,
239, 239, 238, 238, 236, 236, 236, 236,
232, 232, 232, 232, 232, 232, 232, 232,
239, 239, 238, 238, 236, 236, 236, 236,
232, 232, 232, 232, 232, 232, 232, 232,
47, 47, 46, 46, 44, 44, 44, 44,
40, 40, 40, 40, 40, 40, 40, 40,
47, 47, 46, 46, 44, 44, 44, 44,
40, 40, 40, 40, 40, 40, 40, 40,
111, 111, 110, 110, 108, 108, 108, 108,
104, 104, 104, 104, 104, 104, 104, 104,
111, 111, 110, 110, 108, 108, 108, 108,
104, 104, 104, 104, 104, 104, 104, 104,
47, 47, 46, 46, 44, 44, 44, 44,
40, 40, 40, 40, 40, 40, 40, 40,
47, 47, 46, 46, 44, 44, 44, 44,
40, 40, 40, 40, 40, 40, 40, 40,
239, 239, 238, 238, 236, 236, 236, 236,
232, 232, 232, 232, 232, 232, 232, 232,
239, 239, 238, 238, 236, 236, 236, 236,
232, 232, 232, 232, 232, 232, 232, 232,
47, 47, 46, 46, 44, 44, 44, 44,
40, 40, 40, 40, 40, 40, 40, 40,
47, 47, 46, 46, 44, 44, 44, 44,
40, 40, 40, 40, 40, 40, 40, 40,
111, 111, 110, 110, 108, 108, 108, 108,
104, 104, 104, 104, 104, 104, 104, 104,
111, 111, 110, 110, 108, 108, 108, 108,
104, 104, 104, 104, 104, 104, 104, 104,
47, 47, 46, 46, 44, 44, 44, 44,
40, 40, 40, 40, 40, 40, 40, 40,
47, 47, 46, 46, 44, 44, 44, 44,
40, 40, 40, 40, 40, 40, 40, 40,
223, 223, 222, 222, 220, 220, 220, 220,
216, 216, 216, 216, 216, 216, 216, 216,
208, 208, 208, 208, 208, 208, 208, 208,
208, 208, 208, 208, 208, 208, 208, 208,
223, 223, 222, 222, 220, 220, 220, 220,
216, 216, 216, 216, 216, 216, 216, 216,
208, 208, 208, 208, 208, 208, 208, 208,
208, 208, 208, 208, 208, 208, 208, 208,
95, 95, 94, 94, 92, 92, 92, 92,
88, 88, 88, 88, 88, 88, 88, 88,
80, 80, 80, 80, 80, 80, 80, 80,
80, 80, 80, 80, 80, 80, 80, 80,
95, 95, 94, 94, 92, 92, 92, 92,
88, 88, 88, 88, 88, 88, 88, 88,
80, 80, 80, 80, 80, 80, 80, 80,
80, 80, 80, 80, 80, 80, 80, 80,
223, 223, 222, 222, 220, 220, 220, 220,
216, 216, 216, 216, 216, 216, 216, 216,
208, 208, 208, 208, 208, 208, 208, 208,
208, 208, 208, 208, 208, 208, 208, 208,
223, 223, 222, 222, 220, 220, 220, 220,
216, 216, 216, 216, 216, 216, 216, 216,
208, 208, 208, 208, 208, 208, 208, 208,
208, 208, 208, 208, 208, 208, 208, 208,
95, 95, 94, 94, 92, 92, 92, 92,
88, 88, 88, 88, 88, 88, 88, 88,
80, 80, 80, 80, 80, 80, 80, 80,
80, 80, 80, 80, 80, 80, 80, 80,
95, 95, 94, 94, 92, 92, 92, 92,
88, 88, 88, 88, 88, 88, 88, 88,
80, 80, 80, 80, 80, 80, 80, 80,
80, 80, 80, 80, 80, 80, 80, 80,
191, 191, 190, 190, 188, 188, 188, 188,
184, 184, 184, 184, 184, 184, 184, 184,
176, 176, 176, 176, 176, 176, 176, 176,
176, 176, 176, 176, 176, 176, 176, 176,
160, 160, 160, 160, 160, 160, 160, 160,
160, 160, 160, 160, 160, 160, 160, 160,
160, 160, 160, 160, 160, 160, 160, 160,
160, 160, 160, 160, 160, 160, 160, 160,
191, 191, 190, 190, 188, 188, 188, 188,
184, 184, 184, 184, 184, 184, 184, 184,
176, 176, 176, 176, 176, 176, 176, 176,
176, 176, 176, 176, 176, 176, 176, 176,
160, 160, 160, 160, 160, 160, 160, 160,
160, 160, 160, 160, 160, 160, 160, 160,
160, 160, 160, 160, 160, 160, 160, 160,
160, 160, 160, 160, 160, 160, 160, 160,
191, 191, 190, 190, 188, 188, 188, 188,
184, 184, 184, 184, 184, 184, 184, 184,
176, 176, 176, 176, 176, 176, 176, 176,
176, 176, 176, 176, 176, 176, 176, 176,
160, 160, 160, 160, 160, 160, 160, 160,
160, 160, 160, 160, 160, 160, 160, 160,
160, 160, 160, 160, 160, 160, 160, 160,
160, 160, 160, 160, 160, 160, 160, 160,
191, 191, 190, 190, 188, 188, 188, 188,
184, 184, 184, 184, 184, 184, 184, 184,
176, 176, 176, 176, 176, 176, 176, 176,
176, 176, 176, 176, 176, 176, 176, 176,
160, 160, 160, 160, 160, 160, 160, 160,
160, 160, 160, 160, 160, 160, 160, 160,
160, 160, 160, 160, 160, 160, 160, 160,
160, 160, 160, 160, 160, 160, 160, 160,
127, 127, 126, 126, 124, 124, 124, 124,
120, 120, 120, 120, 120, 120, 120, 120,
112, 112, 112, 112, 112, 112, 112, 112,
112, 112, 112, 112, 112, 112, 112, 112,
96, 96, 96, 96, 96, 96, 96, 96,
96, 96, 96, 96, 96, 96, 96, 96,
96, 96, 96, 96, 96, 96, 96, 96,
96, 96, 96, 96, 96, 96, 96, 96,
64, 64, 64, 64, 64, 64, 64, 64,
64, 64, 64, 64, 64, 64, 64, 64,
64, 64, 64, 64, 64, 64, 64, 64,
64, 64, 64, 64, 64, 64, 64, 64,
64, 64, 64, 64, 64, 64, 64, 64,
64, 64, 64, 64, 64, 64, 64, 64,
64, 64, 64, 64, 64, 64, 64, 64,
64, 64, 64, 64, 64, 64, 64, 64,
127, 127, 126, 126, 124, 124, 124, 124,
120, 120, 120, 120, 120, 120, 120, 120,
112, 112, 112, 112, 112, 112, 112, 112,
112, 112, 112, 112, 112, 112, 112, 112,
96, 96, 96, 96, 96, 96, 96, 96,
96, 96, 96, 96, 96, 96, 96, 96,
96, 96, 96, 96, 96, 96, 96, 96,
96, 96, 96, 96, 96, 96, 96, 96,
64, 64, 64, 64, 64, 64, 64, 64,
64, 64, 64, 64, 64, 64, 64, 64,
64, 64, 64, 64, 64, 64, 64, 64,
64, 64, 64, 64, 64, 64, 64, 64,
64, 64, 64, 64, 64, 64, 64, 64,
64, 64, 64, 64, 64, 64, 64, 64,
64, 64, 64, 64, 64, 64, 64, 64,
64, 64, 64, 64, 64, 64, 64, 64,
};

// 65536*kingLoc+256*occ+pinners
// Given a king, some occupied squares, and some pinners, returns all squares
// between a pinner (inclusive) and the king (exclusive). These are squares
// that it is legal for the pinned piece to move to.
// NOTE: pinners and king *also* count as occupied squares.
uint8_t kPinLookup[8*256*256];

}  // namespace

uint8_t sliding_moves(uint8_t loc, uint8_t occ) {
  assert(std::popcount(loc) == 1);
  return kSlideLookup[256 * lsb(loc) + occ];
}

void initialize_sliding() {
  for (int i = 0; i < 8; ++i) {
    const uint8_t piece = 1 << i;
    for (int j = 0; j < 256; ++j) {
      const uint8_t obstacles = j;
      const int idx = i * 256 + j;
      kSlideLookup[idx] = 0;
      if (piece & obstacles) {
        // Invalid state.
        continue;
      } else {
        uint8_t r = 0;
        for (int k = i + 1; k < 8; ++k) {
          r |= 1 << k;
          if (obstacles & (1 << k)) {
            break;
          }
        }
        for (int k = i - 1; k >= 0; --k) {
          r |= 1 << k;
          if (obstacles & (1 << k)) {
            break;
          }
        }
        kSlideLookup[idx] = r;
      }
    }
  }

  for (unsigned i = 0; i < 8; ++i) {
    for (unsigned occ = 0; occ < 256; ++occ) {
      for (unsigned pinners = 0; pinners < 256; ++pinners) {

        int idx = 65536*i+256*occ+pinners;
        uint8_t king = 1 << i;
        kPinLookup[idx] = 0;

        // Ignore positions with no pinners or no occupied squares (besides the king).
        if (pinners == 0) continue;
        if ((occ & ~(king | pinners)) == 0) continue;

        // Ignore positions where the king or pinners are not occupied squares.
        if ((occ & king) != king) continue;
        if ((occ & pinners) != pinners) continue;

        // This should never happen.
        if (king & pinners) continue;

        uint8_t leftPinners = pinners & (king - 1);
        if (leftPinners) {
          // There is a pinner to our left.
          uint8_t between = (king - 1) & ~(uint8_t(1 << safe_msb(leftPinners)) - 1);
          if (std::popcount(between & occ) == 2) {
            kPinLookup[idx] |= between;
          }
        }

        uint8_t rightPinners = pinners & ~(king * 2 - 1);
        if (rightPinners) {
          // There is a pinner to our right.
          uint8_t between = ((1 << lsb_i_promise_board_is_not_empty(rightPinners)) * 2 - 1) & ~(king * 2 - 1);
          if (std::popcount(between & occ) == 2) {
            kPinLookup[idx] |= between;
          }
        }

      }
    }
  }
}

inline uint8_t sliding_pinmask(uint8_t loc, uint8_t occ, uint8_t pinners) {
  assert(std::popcount(loc) == 1);
  return kPinLookup[65536*lsb_i_promise_board_is_not_empty(loc)+256*occ+pinners];
}

}  // namespace ChessEngine

#endif  // MOVEGEN_SLIDING_H
